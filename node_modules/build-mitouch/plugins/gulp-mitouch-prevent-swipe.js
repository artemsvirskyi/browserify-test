var es = require('event-stream'),
	gutil = require('gulp-util'),
	cheerio = require('cheerio'),
	path = require('path'),
	PluginError = gutil.PluginError;

function findAttributes(slideId, structure){
	var slideIndex, attributes = [], chapter;

	Object.keys(structure.chapters).some(function(chapterId){
		chapter = structure.chapters[chapterId];
		if((slideIndex = chapter.content.indexOf(slideId)) !== -1){
			if(slideIndex + 1 === chapter.content.length){
				attributes.push('data-prevent-left-swipe');
			}
			if(slideIndex === 0){
				attributes.push('data-prevent-right-swipe');
			}
			return true;
		}
		return false;
	});

	return attributes;
}

module.exports = function(slideId, env){
	var structureName = path.join(process.cwd(), env.structure),
		structure = require(structureName);

	return es.map(function(file, done){
		var $, article, attributes;

		if(file.isNull()){
			return done(null, file);
		}
		if(file.isStream()){
			return done(new PluginError('gulp-mitouch-prevent-swipe', 'Streaming not supported.'));
		}

		attributes = findAttributes(slideId, structure);

		if(attributes.length){
			$ = cheerio.load(file.contents.toString());
			article = $('.slide');

			attributes.forEach(function(attribute){
				article.attr(attribute, 'true');
				file.contents = new Buffer($.html());
			});
		}

		done(null, file);
	});
};