var gulp = require('gulp'),
	es = require('event-stream'),
	childproc = require('child_process');

module.exports = function(options){
	return es.map(function (file, callback) {
		var convert = 'node_modules/build/utilities/converter/convert',
			child,
			width = options.width || 200,
			height = options.height || 150;

		child = childproc.spawn(convert, [file.path, '-resize', width + 'x' + height,  '-'], {cwd: process.cwd()});

		child.stdout.on('data', function (stdout){
			file.contents = new Buffer(stdout);
			callback(null, file);
		});

//		child.stdin.write(file.contents.toString());

		child.on('close', function(code){
			console.log('Done with exit code', code);
		});

		child.stderr.setEncoding('utf8');
		child.stderr.on('data', function (data_err){
			console.log('Resize child process error', data_err);
		});

	});
};